<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/core-signals/core-signals.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/core-icons/core-icons.html">
<link rel="import" href="/bower_components/voice-elements/dist/voice-recognition.html">

<polymer-element name="george-g-button" extends="paper-fab">
  <template>

    <style>
      :host {
        background: #FFEB3B;
        z-index: 1;
        top: 30px;
        transition:all 0.2s;
        -webkit-transition:all 0.2s;
        -moz-transition:all 0.2s;
      }

      a {
        color: #000;
      }

      .hide {
        display: none;
      }

      .show {
        display: block;
      }

      :host(.expand) {
        border-radius:1%;
        transition:all 0.2s;
        -webkit-transition:all 0.2s;
        -moz-transition:all 0.2s;
        width: 641px;
        height: 300px;
        top: 130px;
      }

        @media (max-width: 860px) {
          :host(.expand) {
            width: 540px;
            height: 360px;
          }
        }

        @media (max-width: 750px) {
          paper-input {
            width: 80%;
          }
        }

        @media (max-width: 720px) {
          :host(.expand) {
            width: 340px;
            height: 440px;
          }
        }

      .categoryButton {
        width: 140px;
        height: 80px;
        float: left;
      }

      paper-input {
        width: 89%;
      }

      #start_button {
        border: 0;
        padding: 0;
        margin: 0;
        display: inline-block;
        float: left;
        background-color: transparent;
      }

    .alignTextInMiddle {
      display: table;
      height: 50px;
    }

    span {
      display: table-cell;
      vertical-align: middle;
    }

    </style>
  <content>
    <core-ajax id="ajax" auto url="/bower_components/george-elements/profiles.json" on-core-response="{{jsonLoaded}}" handleAs="json"></core-ajax>
    <div id="container">
      <img src="/images/g-logo.png" />
      <div id="content" class="{{showOrHide}}">
        <paper-input id="georgeSearch" on-change="{{analyseSearch}}" label="Search"></paper-input>
        <paper-button style="min-width:10px;"><core-icon icon="search" style="color:black;"></core-icon></paper-button>
        <voice-recognition id="georgeRecognition"></voice-recognition>
        <section>
          <paper-button class="categoryButton" on-click="{{askGeorge}}"><div class="alignTextInMiddle"><span>Ask George</span></div></paper-button>
          <a href="/#/1"><paper-button class="categoryButton"><div class="alignTextInMiddle"><span>Home & Garden</span></div></paper-button></a>
          <a href="/#/2"><paper-button class="categoryButton"><div class="alignTextInMiddle"><span>Women</span></div></paper-button></a>
          <a href="/#/3"><paper-button class="categoryButton"><div class="alignTextInMiddle"><span>Men</span></div></paper-button></a>
        </section>
        <section>
          <a href="/#/4"><paper-button class="categoryButton"><div class="alignTextInMiddle"><span>Boys</span></div></paper-button></a>
          <a href="/#/5"><paper-button class="categoryButton"><div class="alignTextInMiddle"><span>Girls</span></div></paper-button></a>
          <a href="/#/6"><paper-button class="categoryButton"><div class="alignTextInMiddle"><span>Baby</span></div></paper-button></a>
          <a href="/#/7"><paper-button class="categoryButton"><div class="alignTextInMiddle"><span>School</span></div></paper-button></a>
        </section>
      </div>
    </content>
  </template>

  <script>
    Polymer("george-g-button", {
      ready: function() {
        this.showOrHide = "hide";

        this.addEventListener('click', this.showContent);
        this.addEventListener('blur', this.hideContent);

        CoreStyle.g.paperInput.focusedColor = 'black';
      },

      profileRelations: [
        {
          "profileKey": "son",
          "keywords": [
            "son"
          ]
        },
        {
          "profileKey": "daughter",
          "keywords": [
            "daughter"
          ]
        },
        {
          "profileKey": "mum",
          "keywords": [
            "mother", "mum"
          ]
        },
        {
          "profileKey": "dad",
          "keywords": [
            "father", "dad"
          ]
        },
        {
          "profileKey": "brother",
          "keywords": [
            "bro", "brother"
          ],
        },
        {
          "profileKey": "sister",
          "keywords": [
            "sis", "sister"
          ]
        },
      ],

      colours: [
        "red", "green", "blue", "yellow", "pink",
        "purple", "orange", "violet", "navy",
        "white", "black", "grey"
      ],

      clothesKeywords: [
        {
          "clothesKey": "tee",
          "keywords": [
            "tee", "t-shirt", "tshirt", "tshirts", "t-shirts", "tees"
          ]
        },
        {
          "clothesKey": "jeans",
          "keywords": [
            "jeans", "jeggings", "jean", "jegging"
          ]
        },
        {
          "clothesKey": "dress",
          "keywords": [
            "dress", "dresses"
          ]
        }
      ],

      sizes: [
        {
          "key": "m",
          "keywords": [
            "medium", "m"
          ]
        }
      ],

      nonSearchTerms: [
        "and", "for", "with", "my", "your",
        "me", "clothes", "or"
      ],

      matchingRelations: [],
      matchingClothes: [],
      matchingColours: [],
      matchedWords: [],
      matchingProfiles: [],

      analyseSearch: function() {
        var searchInput = this.$.georgeSearch;
        var searchTerm = searchInput.value.replace("/", "");
        var words = searchTerm.split(" ");
        this.matchingRelations = []; this.matchingClothes = []; this.matchingColours = [];
        this.matchedWords = []; this.matchingProfiles = [];

        for (var i = 0; i < words.length; i++) {
          this.analyseWord(words[i]);
        }

        this.performSearch(searchTerm);
      },

      performSearch: function(term) {
        term = this.stripMatchingWords(term);
        for (var i = 0; i < this.matchingRelations.length; i++) {
          for (var j = 0; j < this.profiles.length; j++) {
            if (this.profiles[j].relation.toLowerCase() == this.matchingRelations[i].toLowerCase()) {
              this.matchingProfiles.push(this.profiles[j].id);
            }
          }
        }

        if (this.matchingProfiles.length == 0) {
          var selectedProfile = this.getSelectedProfileData();
          this.matchingProfiles.push(selectedProfile.id);
        }

        document.location.href = "/#/productresultsgrid/" + term + "\\" + this.matchingColours.join() + "\\" + this.matchingProfiles.join() + "\\" + this.matchingClothes.join();
      },

      stripMatchingWords: function(term) {
        var parsedTerm = term;
        for (var i = 0; i < this.matchedWords.length; i++) {
          parsedTerm = parsedTerm.replace(this.matchedWords[i], "");
          parsedTerm = parsedTerm.replace("  ", " ");
        }

        for (var i = 0; i < this.nonSearchTerms.length; i++) {
          parsedTerm = parsedTerm.replace(this.nonSearchTerms[i], "");
          parsedTerm = parsedTerm.replace("  ", " ");
        }
        return parsedTerm;
      },

      analyseWord: function(word) {
        var profileKey = this.isProfileKeyword(word);
        if (profileKey != "") {
          this.matchingRelations.push(profileKey);
          this.matchedWords.push(word);
        }

        var clothesKey = this.isClothesKeyword(word);
        if (clothesKey != "") {
          this.matchingClothes.push(clothesKey);
          this.matchedWords.push(word);
        }

        for (var i = 0; i < this.colours.length; i++) {
          if (word.toLowerCase() == this.colours[i].toLowerCase()) {
            this.matchingColours.push(word);
            this.matchedWords.push(word);
          }
        }

        for (var i = 0; i < this.profiles.length; i++) {
          if (this.profiles[i].name.toLowerCase() == word.toLowerCase()) {
            this.matchingProfiles.push(this.profiles[i].id);
            this.matchedWords.push(word);
          }
        }
      },

      getSelectedProfileData: function() {
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf("profileData=") != -1) {
            return JSON.parse(c.substring(12, c.length));
          }
        }
        return {
          "id": "1"
        };
      },

      isClothesKeyword: function(word) {
        var clothes = this.clothesKeywords;
        for (var i = 0; i < clothes.length; i++) {
          var keywords = clothes[i].keywords;
          for (var j = 0; j < keywords.length; j++) {
            if (keywords[j] == word.toLowerCase()) {
              return clothes[i].clothesKey;
            }
          }
        }
        return "";
      },

      isProfileKeyword: function(word) {
        var relations = this.profileRelations;
        for (var i = 0; i < relations.length; i++) {
          var keywords = relations[i].keywords;
          for (var j = 0; j < keywords.length; j++) {
            if (keywords[j] == word.toLowerCase()) {
              return relations[i].profileKey;
            }
          }
        }
        return "";
      },

      isProfileName: function(word) {
        // TODO: Get the profiles out and check them
      },

      jsonLoaded: function() {
        this.profiles = this.$.ajax.response.slice(0);
      },

      showContent: function() {
        this.className = "expand";
        this.showOrHide = "show";
      },

      hideContent: function() {
        this.className = "";
        this.showOrHide = "hide";
      },

      askGeorge: function() {
        var that = this;
        that.clearResult = true;
        var recog = this.$.georgeRecognition;
        var search = this.$.georgeSearch;
        recog.start();
        recog.addEventListener('onresult', function(event) {
          if (that.clearResult) {
            search.inputValue = '';
            that.clearResult = false;
          }
          that.showContent();
          search.value = event.detail.result;
          that.analyseSearch();
        });
        recog.addEventListener('result', function(event) {
          that.clearResult = true;
        });
      },
    });
  </script>
</polymer-element>
