<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-signals/core-signals.html">
<link rel="import" href="../core-animated-pages/core-animated-pages.html">
<link rel="import" href="../core-animated-pages/transitions/hero-transition.html">
<link rel="import" href="../core-animated-pages/transitions/cross-fade.html">
<link rel="import" href="../core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../core-animated-pages/transitions/slide-down.html">
<link rel="import" href="../core-animated-pages/transitions/slide-up.html">
<link rel="import" href="../core-animated-pages/transitions/tile-cascade.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-dropdown/paper-dropdown.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../font-roboto/roboto.html">



  <polymer-element name="george-checkout">
  <template>
    <core-signals on-core-signal-checkout="{{checkoutSignal}}"></core-signals>
    <style>
      .product-name{
        font-size:1.4em;
      }
      .checkout_image{
        height: 100px;
      }
    </style>
    <div id="checkout_summary" align="center"> Sub-Total: £{{sub_total_price}} Items Ordered: {{sub_total_items}} Orders: {{sub_total_orders}} </div>
    <template  id="checkout_item" repeat="{{basket as product}}">
      <div class='item_span' align="center">
        <img class='checkout_image' src='{{product.image}}'>
        <p class='product-name'><b>{{product.product}}</b> Price: {{product.price}} Size: {{product.size}} Quantity: <paper-icon-button icon="add" on-click="{{alterOrderAdd}}"></paper-icon-button>{{product.quantity}}<paper-icon-button icon="remove" on-click="{{alterOrderSubtract}}"></paper-icon-button></p>
        <paper-icon-button icon=delete on-click="{{updateCheckout}}"></paper-icon-button>
      </div>
    </template>
    <div id="deliveryOptList" align="center">Delivery Method :
      <paper-dropdown-menu label="Select a Delivery Method">
        <paper-dropdown class="dropdown">
          <core-menu id="deliveryMethod" class="menu" on-core-select="{{deliverMethodChange}}">
            <template repeat="{{deliveryOptions}}">
              <paper-item value="{{cost}}">{{option}}</paper-item>
            </template>
          </core-menu>
        </paper-dropdown>
      </paper-dropdown-menu> Total Price: £{{total_price}}</div>
  </template>
  <script>

    Polymer('george-checkout', {

      basket: [],
      quantities: ['1', '2', '3', '4', '5'],
      deliveryOptions: [{
        option:'Free Click and Collect',
        cost:0
      },{
        option:'Free Home Delivery',
        cost:0
      },{
        option:'Free Delivery When You Spend £45 Or More',
        cost:0
      },{
        option:'Standard Home Delivery',
        cost:2.95
      },{
        option:'Next Day Home Delivery',
        cost:4.50
      },{
        option:'Named Day Home Delivery',
        cost:4.50
      },{
        option:'Named Day With Time Slot Delivery',
        cost:5.95
      },{
        option:'Standard Large Item Delivery',
        cost:8.95
      },{
        option:'Collect+',
        cost:4.50
      },{
        option:'International Delivery',
        cost:5
      }],
      items : 1,
      sub_total_price: 0,
      sub_total_items: 0,
      sub_total_orders: 0,
      total_price: 0,

      ready: function(){
        var basket_name = 'george_basket=';
        if(this.basket.length == 0){
          var test = document.cookie.split(';');
          for(var i=0; i < test.length;i++){
            var cookie_search = test[i];
            if(cookie_search.indexOf(basket_name) != -1){
              basket_broken = (cookie_search.substring(basket_name.length+2, cookie_search.length-1)).split('},');
              if(basket_broken != ']' && basket_broken != ''){
                for( var j = 0; j < basket_broken.length;j++){
                  if(j+1 == basket_broken.length){
                    var data = JSON.parse(basket_broken[j]);
                  } else {
                    var data = JSON.parse(basket_broken[j]+'}');
                  }
                  data.id = this.items;
                  this.sub_total = this.sub_total + data.price * data.quantity;
                  this.basket.push(data);
                  this.items++;
                }
              }
            }
          }
        }
        this.recalculatePrices();
      },

      updateCheckout: function(e, detail, sender) {
        var product_id = e.target.templateInstance.model.product;
        for(var i = 0; i< this.basket.length; i++){
          if(product_id.id == this.basket[i].id){
            this.basket.splice(i,1);
          }
        }
        var newBasket = this.basket;
        this.fire('core-signal', {name:"basket-delete", data:newBasket});
        document.cookie = "george_basket=; expires= Thu, 18 Dec 2013 12:00:00 UTC;";
        document.cookie = "george_basket="+JSON.stringify(this.basket)+";";
        this.recalculatePrices();
      },

      alterOrderAdd: function(e, detail, sender) {
        var product_id = e.target.templateInstance.model.product;
        for(var i = 0; i< this.basket.length; i++){
          if(product_id.id == this.basket[i].id){
            this.basket[i].quantity = this.basket[i].quantity+1;
          }
        }
        var newBasket = this.basket;
        this.fire('core-signal', {name:"basket-alter", data:newBasket});
        document.cookie = "george_basket=; expires= Thu, 18 Dec 2013 12:00:00 UTC;";
        document.cookie = "george_basket="+JSON.stringify(this.basket)+";";
        this.recalculatePrices();
      },

      alterOrderSubtract: function(e, detail, sender) {
        var product_id = e.target.templateInstance.model.product;
        for(var i = 0; i< this.basket.length; i++){
          if(product_id.id == this.basket[i].id){
            this.basket[i].quantity = this.basket[i].quantity-1;
          }
        }
        var newBasket = this.basket;
        this.fire('core-signal', {name:"basket-alter", data:newBasket});
        document.cookie = "george_basket=; expires= Thu, 18 Dec 2013 12:00:00 UTC;";
        document.cookie = "george_basket="+JSON.stringify(this.basket)+";";
        this.recalculatePrices();
      },


      checkoutSignal: function(e, detail, sender) {
        //console.log(detail);
        this.basket = detail;
        this.recalculatePrices();
      },

      deliverMethodChange: function(e, detail, sender) {
        this.recalculatePrices();
      },

      recalculatePrices: function(){
        this.sub_total_price = 0;
        this.sub_total_items = 0;
        this.sub_total_orders = 0;
        this.total_price = 0;
        for(var i = 0; i< this.basket.length; i++){
          this.total_price = this.sub_total_price + this.basket[i].price * this.basket[i].quantity;
          this.sub_total_price = this.sub_total_price + this.basket[i].price * this.basket[i].quantity;
          this.sub_total_items = this.sub_total_items + this.basket[i].quantity;
          this.sub_total_orders++;
        }
        if(this.$.deliveryMethod.selected != null){
          this.total_price = this.total_price + this.deliveryOptions[this.$.deliveryMethod.selected].cost;
        }
      }

    });

  </script>
  </polymer-element>
